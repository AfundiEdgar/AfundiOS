name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.2.3)'
        required: true
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      release_id: ${{ steps.create_release.outputs.id }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Generate changelog
      run: |
        # Generate changelog from git commits
        echo "# Changelog" > CHANGELOG.md
        echo "" >> CHANGELOG.md
        
        # Get the previous tag
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
        CURRENT_TAG=${GITHUB_REF#refs/tags/}
        
        if [ -n "$PREV_TAG" ]; then
          echo "## Changes since $PREV_TAG" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          
          # Get commits since last tag
          git log --oneline --pretty=format:"- %s (%h)" $PREV_TAG..HEAD >> CHANGELOG.md
        else
          echo "## Initial Release" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "- Initial release of AfundiOS with Redis caching" >> CHANGELOG.md
        fi
        
        echo "" >> CHANGELOG.md
        echo "### Features" >> CHANGELOG.md
        echo "- ðŸš€ Redis caching for embeddings, LLM responses, and vector search" >> CHANGELOG.md
        echo "- ðŸ“Š Cache performance monitoring and analytics" >> CHANGELOG.md
        echo "- ðŸ”§ Comprehensive API for cache management" >> CHANGELOG.md
        echo "- ðŸ³ Docker and Kubernetes deployment configurations" >> CHANGELOG.md
        echo "- ðŸ›¡ï¸ Security scanning and vulnerability assessments" >> CHANGELOG.md

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: AfundiOS ${{ github.ref_name }}
        body_path: CHANGELOG.md
        draft: false
        prerelease: false

  build-release-images:
    runs-on: ubuntu-latest
    needs: create-release
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata for backend
      id: backend-meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend
        tags: |
          type=ref,event=tag
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}

    - name: Build and push backend
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        push: true
        tags: ${{ steps.backend-meta.outputs.tags }}
        labels: ${{ steps.backend-meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Extract metadata for frontend
      id: frontend-meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend
        tags: |
          type=ref,event=tag
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}

    - name: Build and push frontend
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        push: true
        tags: ${{ steps.frontend-meta.outputs.tags }}
        labels: ${{ steps.frontend-meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  package-release:
    runs-on: ubuntu-latest
    needs: [create-release, build-release-images]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create deployment package
      run: |
        mkdir -p release-package
        
        # Copy deployment files
        cp docker-compose.yml release-package/
        cp docker-compose.redis.yml release-package/
        cp .env.example release-package/
        cp REDIS_CACHING_GUIDE.md release-package/
        cp scripts/setup_redis.sh release-package/
        
        # Create deployment instructions
        cat > release-package/DEPLOYMENT.md << 'EOF'
        # AfundiOS Deployment Guide
        
        ## Quick Start
        
        1. **Setup Redis**:
           ```bash
           chmod +x setup_redis.sh
           ./setup_redis.sh
           ```
        
        2. **Configure Environment**:
           ```bash
           cp .env.example .env
           # Edit .env with your settings
           ```
        
        3. **Deploy with Docker**:
           ```bash
           docker-compose up -d
           ```
        
        ## Production Deployment
        
        For production deployment with Redis cluster:
        
        ```bash
        # Start Redis cluster
        docker-compose -f docker-compose.redis.yml up -d
        
        # Deploy application
        docker-compose up -d
        ```
        
        See REDIS_CACHING_GUIDE.md for detailed configuration options.
        EOF
        
        # Create Kubernetes manifests
        cat > release-package/kubernetes-manifests.yml << 'EOF'
        apiVersion: v1
        kind: Namespace
        metadata:
          name: afundios
        ---
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: redis
          namespace: afundios
        spec:
          replicas: 1
          selector:
            matchLabels:
              app: redis
          template:
            metadata:
              labels:
                app: redis
            spec:
              containers:
              - name: redis
                image: redis:7.2-alpine
                ports:
                - containerPort: 6379
        ---
        apiVersion: v1
        kind: Service
        metadata:
          name: redis
          namespace: afundios
        spec:
          selector:
            app: redis
          ports:
          - port: 6379
            targetPort: 6379
        EOF
        
        # Package everything
        tar -czf afundios-${{ github.ref_name }}-deployment.tar.gz -C release-package .

    - name: Upload deployment package
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: afundios-${{ github.ref_name }}-deployment.tar.gz
        asset_name: afundios-${{ github.ref_name }}-deployment.tar.gz
        asset_content_type: application/gzip

  notify-release:
    runs-on: ubuntu-latest
    needs: [create-release, build-release-images, package-release]
    if: always()
    
    steps:
    - name: Notify release completion
      uses: actions/github-script@v6
      with:
        script: |
          const release_url = `https://github.com/${context.repo.owner}/${context.repo.repo}/releases/tag/${context.ref.replace('refs/tags/', '')}`;
          
          const message = `
          ðŸŽ‰ **AfundiOS ${context.ref.replace('refs/tags/', '')} Released!**
          
          **What's New:**
          - ðŸš€ Redis caching implementation for 5-20x performance improvement
          - ðŸ“Š Cache monitoring and analytics dashboard
          - ðŸ”§ Complete API for cache management
          - ðŸ³ Production-ready Docker configurations
          - ðŸ›¡ï¸ Enhanced security scanning
          
          **Download:** [${context.ref.replace('refs/tags/', '')}](${release_url})
          
          **Quick Start:**
          \`\`\`bash
          wget https://github.com/${context.repo.owner}/${context.repo.repo}/releases/download/${context.ref.replace('refs/tags/', '')}/afundios-${context.ref.replace('refs/tags/', '')}-deployment.tar.gz
          tar -xzf afundios-${context.ref.replace('refs/tags/', '')}-deployment.tar.gz
          ./setup_redis.sh
          docker-compose up -d
          \`\`\`
          `;
          
          // Create release announcement issue
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ðŸ“¢ Release Announcement: ${context.ref.replace('refs/tags/', '')}`,
            body: message,
            labels: ['release', 'announcement']
          });